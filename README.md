# Netmaker with Xray Setup

Helper scripts to deploy Netmaker infrastructure with Xray Core in Docker or Podman containers.

## Features

- Compatible with both Docker and Podman
- Automatic setup of Netmaker (server, UI, MQTT broker, proxy)
- Integration with Xray-core on port 443
- Automatic certificate generation
- Persistence support for systemd
- Route synchronization between containers

## Quick Installation

One-line installation command:
```
curl -sfL https://raw.githubusercontent.com/repr0bated/nm-setup-xray/main/scripts/nm-install.sh | sudo bash -s - <DOMAIN>
```

Replace `<DOMAIN>` with your domain name.

## Installation Commands

Setup netmaker server with Xray for your domain:
```
curl -sfL https://raw.githubusercontent.com/repr0bated/nm-setup-xray/main/scripts/nm-install.sh | sudo bash -s - yourdomain.com
```

Join a netmaker network with access TOKEN:
```
curl -sfL https://raw.githubusercontent.com/repr0bated/nm-setup-xray/main/scripts/nm-join.sh | sudo bash -s - <TOKEN>
```

Set up persistence for containers:
```
curl -sfL https://raw.githubusercontent.com/repr0bated/nm-setup-xray/main/scripts/nm-persist.sh | sudo bash -s -
```

Sync routes from containers to host:
```
curl -sfL https://raw.githubusercontent.com/repr0bated/nm-setup-xray/main/scripts/nm-routes.sh | sudo bash -s -
```

## Manual Installation

### Prerequisites

- Linux system with Docker or Podman installed
- Root access (for some operations)
- Basic knowledge of networking

### Installation Steps

1. Clone this repository:
   ```
   git clone https://github.com/repr0bated/nm-setup-xray.git
   cd nm-setup-xray
   ```

2. Run the setup script:
   ```
   ./scripts/nm-setup.sh yourdomain.com
   ```

3. Join a network:
   ```
   ./scripts/nm-join.sh <token>
   ```

4. For persistence across reboots:
   ```
   sudo ./scripts/nm-persist.sh
   ```

## Xray Configuration

Xray (specifically the `xtls/xray-core` image) is integrated into this setup. It's configured to run as a container and handle inbound connections on port 443 using the VLESS protocol with TLS. The Xray binary itself runs inside this container.

All Xray-related configuration files and SSL certificates are stored on the **host machine** and mounted into the Xray container. This makes them easily accessible and editable by you.

### Configuration Files Location

The Xray configuration files are stored on your host machine in:
- `/var/lib/netmaker/xray/` (if you ran the setup scripts as root)
- `$HOME/.local/share/netmaker/xray/` (if you ran the setup scripts as a regular user)

Key files in this directory:
- `config.json`: This is the main Xray configuration file. It dictates Xray's behavior, including inbound/outbound settings, client UUIDs, etc.
- `ssl/`: This subdirectory contains the SSL/TLS certificates used by Xray.
  - `server.key`: The private key for your domain.
  - `server.crt`: The public certificate for your domain.

These files are generated by the `nm-prepare.sh` script (which is called by `nm-setup.sh` and `nm-install.sh`).

### Editing the Xray Configuration

To modify Xray's behavior (e.g., add more users/clients, change protocols, adjust fallbacks):

1.  **Edit the `config.json` file** on your host machine:
    ```bash
    # If running as root
    sudo nano /var/lib/netmaker/xray/config.json

    # If running as a regular user
    nano $HOME/.local/share/netmaker/xray/config.json
    ```

2.  **Restart the Xray container** for the changes to take effect:
    ```bash
    # If using Docker
    docker restart netmaker-xray

    # If using Podman
    podman restart netmaker-xray
    ```

### Default Xray Configuration (VLESS over TCP with TLS)

The default `config.json` created by the scripts sets up an inbound on port 443 using the VLESS protocol.
- **`id`**: A unique client UUID is automatically generated for the first client during installation. This is the "password" your VLESS client will use.
- **`flow`**: Set to `xtls-rprx-direct`.
- **TLS**: Uses the generated `server.crt` and `server.key`.

To add additional clients/users, you can duplicate the client object within the `clients` array in `config.json`, ensuring each has a unique `id` (UUID). You can generate new UUIDs using the `uuidgen` command in your terminal.

Example `clients` array with two users:
```json
"clients": [
  {
    "id": "your-first-auto-generated-uuid", 
    "flow": "xtls-rprx-direct"
  },
  {
    "id": "a-new-manually-added-uuid",   
    "flow": "xtls-rprx-direct"
  }
]
```
Remember to restart the `netmaker-xray` container after modifying `config.json`.

## Script Descriptions

- **nm-install.sh**: All-in-one installation script (for curl installation). Downloads and runs other necessary scripts.
- **nm-prepare.sh**: Prepares the environment: creates directories, generates configurations (including for Xray) and certificates, and pulls required container images.
- **nm-setup.sh**: Deploys the complete Netmaker infrastructure (server, UI, MQTT, proxy) and the Xray container.
- **nm-join.sh**: Helps Netclient instances join the Netmaker network.
- **nm-persist.sh**: Sets up systemd services for persistence of containers across reboots.
- **nm-routes.sh**: Synchronizes routes from Netmaker containers to the host.
- **nm-cleanup.sh**: Removes containers, volumes, and configurations.

## Netmaker Configuration (General)

General Netmaker related configurations (not Xray specific) are stored in:
- `/var/lib/netmaker` (if running as root)
- `$HOME/.local/share/netmaker` (if running as a regular user)

## License

MIT License 